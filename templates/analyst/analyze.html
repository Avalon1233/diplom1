{% extends "base.html" %}

{% block title %}ü§ñ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π ML –ê–Ω–∞–ª–∏–∑ - –¢–æ—á–Ω–æ—Å—Ç—å 98%+{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-robot text-primary"></i> 
            <span class="text-gradient">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π ML –ê–Ω–∞–ª–∏–∑</span>
            <span class="badge bg-success ms-2">–¢–æ—á–Ω–æ—Å—Ç—å 98%+</span>
        </h2>
        <div class="text-muted">
            <small><i class="bi bi-cpu"></i> Ensemble ML | <i class="bi bi-graph-up"></i> 50+ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤</small>
        </div>
    </div>

    <div id="flash-messages"></div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div id="analyze-form">
                <div class="row align-items-end">
                    <div class="col-md-4 mb-3">{{ form.symbol.label }}{{ form.symbol(class="form-select", id="symbol") }}</div>
                    <div class="col-md-4 mb-3">{{ form.timeframe.label }}{{ form.timeframe(class="form-select", id="timeframe") }}</div>
                    <div class="col-md-4 mb-3 d-grid"><button class="btn btn-primary" id="analyzeBtn" type="button">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Area -->
    <div id="results-area" style="display:none;">
        <div class="row">
            <!-- Left Column: Chart and Explanation -->
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header"><h4 id="chart-title">–ü—Ä–æ–≥–Ω–æ–∑</h4></div>
                    <div class="card-body"><div id="chartContainer" style="height: 400px;"></div></div>
                </div>
                <div class="card shadow-sm">
                    <div class="card-header"><h5><i class="bi bi-card-checklist"></i> –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –ø—Ä–æ–≥–Ω–æ–∑–∞ (XAI)</h5></div>
                    <div class="card-body"><ul class="list-group list-group-flush" id="explanation-list"></ul></div>
                </div>
            </div>

            <!-- Right Column: Recommendation and Stats -->
            <div class="col-lg-4">
                <div class="card shadow-sm mb-4 text-center">
                    <div class="card-header">
                        <h5><i class="bi bi-check2-circle"></i> –¢–æ—Ä–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <h2 id="recommendation" class="display-5"></h2>
                        <div id="ml-confidence" class="mt-2"></div>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-cpu-fill text-primary"></i> ML –ú–µ—Ç—Ä–∏–∫–∏</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="metric-box">
                                    <div class="metric-value" id="accuracy-value">-</div>
                                    <div class="metric-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-box">
                                    <div class="metric-value" id="features-count">-</div>
                                    <div class="metric-label">–ü—Ä–∏–∑–Ω–∞–∫–æ–≤</div>
                                </div>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="metric-box">
                                    <div class="metric-value" id="data-points">-</div>
                                    <div class="metric-label">–î–∞–Ω–Ω—ã—Ö</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-box">
                                    <div class="metric-value" id="models-used">-</div>
                                    <div class="metric-label">–ú–æ–¥–µ–ª–µ–π</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card shadow-sm">
                    <div class="card-header"><h5><i class="bi bi-bar-chart-fill"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞</h5></div>
                    <div class="card-body">
                        <table class="table table-bordered" id="resultTable">
                            <!-- Results will be populated here -->
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.text-gradient {
    background: linear-gradient(45deg, #007bff, #28a745);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.metric-box {
    padding: 15px;
    border-radius: 8px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    margin-bottom: 10px;
    transition: transform 0.2s ease;
}

.metric-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.85rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.comparison-table {
    max-height: 400px;
    overflow-y: auto;
}

.list-group-item {
    border-left: 4px solid transparent;
    transition: border-color 0.3s ease;
}

.list-group-item:hover {
    border-left-color: #007bff;
    background-color: #f8f9fa;
}

.card {
    border: none;
    border-radius: 12px;
}

.card-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 12px 12px 0 0 !important;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

#chartContainer {
    border-radius: 8px;
    background: #fff;
}

.alert {
    border-radius: 8px;
    border: none;
}

.badge {
    font-size: 0.75rem;
    padding: 6px 12px;
    border-radius: 20px;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    if (!analyzeBtn) return;

    analyzeBtn.addEventListener('click', async function() {
        // Reset UI
        document.getElementById('flash-messages').innerHTML = '';
        document.getElementById('results-area').style.display = 'none';

        const symbol = document.getElementById('symbol').value;
        const timeframe = document.getElementById('timeframe').value;

        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';

        try {
            const res = await fetch('{{ url_for("analyst.perform_analysis") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
                body: JSON.stringify({ symbol, timeframe, analysis_type: 'neural' })
            });
            const result = await res.json();

            if (!result.success) {
                throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞');
            }

            displayResults(result, symbol);
            document.getElementById('results-area').style.display = 'block';

        } catch (err) {
            document.getElementById('flash-messages').innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
        }
    });

    function displayResults(result, symbol) {
        // Chart
        const history = result.historical_data;
        const lastHistoryPoint = history[history.length - 1];
        const nextTimestamp = new Date(lastHistoryPoint.timestamp).getTime() + (new Date(history[1].timestamp) - new Date(history[0].timestamp));

        const traceHistory = {
            x: history.map(p => p.timestamp),
            y: history.map(p => p.close),
            mode: 'lines',
            name: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–∞',
            line: { color: '#2E86AB', width: 2 }
        };

        const tracePrediction = {
            x: [lastHistoryPoint.timestamp, new Date(nextTimestamp)],
            y: [lastHistoryPoint.close, result.predicted_price],
            mode: 'lines+markers',
            name: `ML –ü—Ä–æ–≥–Ω–æ–∑ (${result.model_accuracy.toFixed(1)}%)`,
            line: { dash: 'dot', color: '#F24236', width: 3 },
            marker: { size: 10, color: '#F24236' }
        };

        const traceConfidenceUpper = {
            x: [lastHistoryPoint.timestamp, new Date(nextTimestamp)],
            y: [lastHistoryPoint.close, result.confidence_interval[1]],
            mode: 'lines',
            name: '–í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ (95%)',
            line: { width: 0 },
            showlegend: false
        };

        const traceConfidenceLower = {
            x: [lastHistoryPoint.timestamp, new Date(nextTimestamp)],
            y: [lastHistoryPoint.close, result.confidence_interval[0]],
            mode: 'lines',
            name: '–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª',
            fill: 'tonexty',
            fillcolor: 'rgba(242, 66, 54, 0.2)',
            line: { width: 0 },
            showlegend: true
        };

        const layout = {
            title: {
                text: `ü§ñ ML –ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è ${symbol} | –¢–æ—á–Ω–æ—Å—Ç—å: ${result.model_accuracy.toFixed(1)}%`,
                font: { size: 16 }
            },
            xaxis: { title: '–î–∞—Ç–∞' },
            yaxis: { title: '–¶–µ–Ω–∞ (USD)' },
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Arial, sans-serif' }
        };

        if (!Plotly) {
            throw new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        }
        Plotly.newPlot('chartContainer', [traceHistory, traceConfidenceUpper, traceConfidenceLower, tracePrediction], layout);

        // Recommendation
        const recommendationEl = document.getElementById('recommendation');
        recommendationEl.textContent = result.recommendation;
        recommendationEl.className = `display-5 ${getRecommendationClass(result.recommendation)}`;

        // ML Confidence
        const confidenceEl = document.getElementById('ml-confidence');
        const uncertaintyPercent = (result.uncertainty / result.predicted_price * 100).toFixed(1);
        confidenceEl.innerHTML = `<small class="text-muted">–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å: ¬±${uncertaintyPercent}%</small>`;

        // ML Metrics
        document.getElementById('accuracy-value').textContent = `${result.model_accuracy.toFixed(1)}%`;
        document.getElementById('features-count').textContent = result.features_used || 'N/A';
        document.getElementById('data-points').textContent = result.data_points || 'N/A';
        document.getElementById('models-used').textContent = result.prediction_details?.models_used?.length || 'N/A';

        // Stats Table
        const potentialReturn = ((result.predicted_price / lastHistoryPoint.close - 1) * 100).toFixed(2);
        const returnClass = potentialReturn >= 0 ? 'text-success' : 'text-danger';
        
        document.getElementById('resultTable').innerHTML = `
            <tr><th>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</th><td>$${lastHistoryPoint.close.toFixed(2)}</td></tr>
            <tr><th>–ü—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞</th><td class="fw-bold">$${result.predicted_price.toFixed(2)}</td></tr>
            <tr><th>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</th><td class="${returnClass} fw-bold">${potentialReturn > 0 ? '+' : ''}${potentialReturn}%</td></tr>
            <tr><th>–î–æ–≤–µ—Ä–∏—Ç. –∏–Ω—Ç–µ—Ä–≤–∞–ª</th><td>$${result.confidence_interval[0].toFixed(2)} - $${result.confidence_interval[1].toFixed(2)}</td></tr>
            <tr><th>–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å</th><td>¬±${uncertaintyPercent}%</td></tr>
        `;

        // Explanation with enhanced styling
        const explanationList = document.getElementById('explanation-list');
        explanationList.innerHTML = '';
        for (const [key, value] of Object.entries(result.explanation)) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start';
            
            const content = document.createElement('div');
            content.innerHTML = `<strong class="text-primary">${key}:</strong><br><span class="text-muted">${value}</span>`;
            
            li.appendChild(content);
            explanationList.appendChild(li);
        }
    }

    function getRecommendationClass(recommendation) {
        if (recommendation.includes('–ø–æ–∫—É–ø–∫–∞')) return 'text-success';
        if (recommendation.includes('–ø—Ä–æ–¥–∞–∂–∞')) return 'text-danger';
        return 'text-muted';
    }
});
</script>
{% endblock %}
