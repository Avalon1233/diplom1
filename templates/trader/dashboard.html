{% extends "base.html" %}

{% block title %}Панель трейдера{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }
    .portfolio-chart {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        color: white;
    }
    .mini-chart {
        height: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="bi bi-speedometer2 text-primary"></i>
                        Панель трейдера
                    </h1>
                    <p class="text-muted mb-0">Добро пожаловать, {{ current_user.full_name }}! Управляйте своим портфолио и торговыми операциями</p>
                </div>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <small class="text-muted">Последнее обновление:</small>
                        <div class="fw-bold text-success"><span id="lastUpdatedTime">--:--:--</span></div>
                    </div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i> Обновить
                    </button>
                    <span class="badge bg-success">
                        <i class="bi bi-circle-fill blink"></i> Live
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Overview Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 portfolio-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-wallet2 text-primary fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">Общий баланс</div>
                            <div class="h4 mb-0" id="totalBalance">$12,345.67</div>
                            <div class="text-success small">
                                <i class="bi bi-arrow-up"></i> +2.34% (24ч)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 portfolio-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-graph-up-arrow text-success fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">Прибыль/Убыток</div>
                            <div class="h4 mb-0 text-success" id="totalPnL">+$1,234.56</div>
                            <div class="text-success small">
                                <i class="bi bi-arrow-up"></i> +12.5%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 portfolio-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-pie-chart text-info fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">Активные позиции</div>
                            <div class="h4 mb-0" id="activePositions">8</div>
                            <div class="text-info small">
                                <i class="bi bi-coin"></i> 5 криптовалют
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 portfolio-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-clock-history text-warning fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">Открытые ордера</div>
                            <div class="h4 mb-0" id="openOrders">3</div>
                            <div class="text-warning small">
                                <i class="bi bi-hourglass-split"></i> Ожидают
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Portfolio Chart -->
        <div class="col-xl-8 col-lg-7 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up text-primary me-2"></i>
                            Динамика портфолио
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="timeframe" id="tf1d" checked>
                            <label class="btn btn-outline-primary" for="tf1d">1Д</label>
                            <input type="radio" class="btn-check" name="timeframe" id="tf1w">
                            <label class="btn btn-outline-primary" for="tf1w">1Н</label>
                            <input type="radio" class="btn-check" name="timeframe" id="tf1m">
                            <label class="btn btn-outline-primary" for="tf1m">1М</label>
                            <input type="radio" class="btn-check" name="timeframe" id="tf3m">
                            <label class="btn btn-outline-primary" for="tf3m">3М</label>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="portfolioChart" style="height: 300px;">
                        <!-- Chart will be rendered here -->
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <i class="bi bi-graph-up fs-1 mb-3"></i>
                                <p>График портфолио загружается...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Watchlist -->
        <div class="col-xl-4 col-lg-5 mb-4">
            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning text-warning me-2"></i>
                        Быстрые действия
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <a href="{{ url_for('trader.market') }}" class="btn btn-success w-100">
                                <i class="bi bi-arrow-up-circle me-1"></i>
                                Купить
                            </a>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-danger w-100" onclick="openQuickSell()">
                                <i class="bi bi-arrow-down-circle me-1"></i>
                                Продать
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" onclick="openAlertModal()">
                                <i class="bi bi-bell me-1"></i>
                                Алерт
                            </button>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('analyst.analyze') }}" class="btn btn-outline-info w-100">
                                <i class="bi bi-graph-up me-1"></i>
                                Анализ
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watchlist -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-star text-warning me-2"></i>
                            Избранное
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="addToWatchlist()">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="watchlist">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-currency-bitcoin text-warning me-2"></i>
                                <div>
                                    <div class="fw-bold">BTC/USDT</div>
                                    <small class="text-muted">Bitcoin</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">$43,250.00</div>
                                <small class="text-success">+2.34%</small>
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-ethereum text-info me-2"></i>
                                <div>
                                    <div class="fw-bold">ETH/USDT</div>
                                    <small class="text-muted">Ethereum</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">$2,650.00</div>
                                <small class="text-danger">-1.23%</small>
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-coin text-secondary me-2"></i>
                                <div>
                                    <div class="fw-bold">BNB/USDT</div>
                                    <small class="text-muted">Binance Coin</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">$310.50</div>
                                <small class="text-success">+0.87%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity & Portfolio Holdings -->
    <div class="row">
        <!-- Recent Activity -->
        <div class="col-xl-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history text-info me-2"></i>
                        Последние операции
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0 px-4 py-3">Время</th>
                                    <th class="border-0 px-4 py-3">Тип</th>
                                    <th class="border-0 px-4 py-3">Пара</th>
                                    <th class="border-0 px-4 py-3 text-end">Сумма</th>
                                    <th class="border-0 px-4 py-3 text-center">Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3">
                                        <small class="text-muted">10:30</small>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="badge bg-success bg-opacity-10 text-success">
                                            <i class="bi bi-arrow-up me-1"></i>Покупка
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">BTC/USDT</td>
                                    <td class="px-4 py-3 text-end">$1,250.00</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="badge bg-success">Выполнен</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <small class="text-muted">09:15</small>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="badge bg-danger bg-opacity-10 text-danger">
                                            <i class="bi bi-arrow-down me-1"></i>Продажа
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">ETH/USDT</td>
                                    <td class="px-4 py-3 text-end">$800.00</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="badge bg-warning">Ожидает</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <small class="text-muted">08:45</small>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="badge bg-success bg-opacity-10 text-success">
                                            <i class="bi bi-arrow-up me-1"></i>Покупка
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">ADA/USDT</td>
                                    <td class="px-4 py-3 text-end">$500.00</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="badge bg-success">Выполнен</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-0">
                    <div class="text-center">
                        <a href="#" class="btn btn-sm btn-outline-primary">Показать все операции</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Holdings -->
        <div class="col-xl-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart text-primary me-2"></i>
                        Состав портфолио
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0 px-4 py-3">Актив</th>
                                    <th class="border-0 px-4 py-3 text-end">Количество</th>
                                    <th class="border-0 px-4 py-3 text-end">Стоимость</th>
                                    <th class="border-0 px-4 py-3 text-end">Доля</th>
                                    <th class="border-0 px-4 py-3 text-end">P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-currency-bitcoin text-warning me-2"></i>
                                            <div>
                                                <div class="fw-bold">BTC</div>
                                                <small class="text-muted">Bitcoin</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-end">0.15432</td>
                                    <td class="px-4 py-3 text-end">$6,670.00</td>
                                    <td class="px-4 py-3 text-end">54.1%</td>
                                    <td class="px-4 py-3 text-end text-success">+$567.89</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-ethereum text-info me-2"></i>
                                            <div>
                                                <div class="fw-bold">ETH</div>
                                                <small class="text-muted">Ethereum</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-end">1.8765</td>
                                    <td class="px-4 py-3 text-end">$4,972.25</td>
                                    <td class="px-4 py-3 text-end">40.3%</td>
                                    <td class="px-4 py-3 text-end text-success">+$234.56</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-coin text-secondary me-2"></i>
                                            <div>
                                                <div class="fw-bold">BNB</div>
                                                <small class="text-muted">Binance Coin</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-end">2.156</td>
                                    <td class="px-4 py-3 text-end">$669.42</td>
                                    <td class="px-4 py-3 text-end">5.4%</td>
                                    <td class="px-4 py-3 text-end text-danger">-$23.45</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-0">
                    <div class="text-center">
                        <a href="{{ url_for('trader.market') }}" class="btn btn-sm btn-outline-primary">Подробнее о портфолио</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='dist/dashboard.js') }}"></script>

<!-- Fallback JavaScript for enhanced functionality -->
<script>
// Check if React components loaded successfully
if (!document.getElementById('react-dashboard').hasChildNodes()) {
    console.warn('React components not loaded, using fallback functionality');
    
    // Initialize dashboard functionality
    initializeDashboard();
}

function initializeDashboard() {
    // Auto-refresh data every 30 seconds
    setInterval(updateDashboardData, 30000);
    
    // Initialize portfolio chart
    initializePortfolioChart();
    
    // Load watchlist
    loadWatchlist();
    // Set initial last updated time
    setLastUpdatedNow();
}

function refreshDashboard() {
    location.reload();
}

function updateDashboardData() {
    // Fetch latest portfolio data
    fetch('/trader/api/portfolio')
        .then(response => response.json())
        .then(data => {
            updatePortfolioCards(data);
            updateWatchlist();
            setLastUpdatedNow();
        })
        .catch(error => console.error('Error updating dashboard:', error));
}

function updatePortfolioCards(data) {
    if (data.total_balance) {
        document.getElementById('totalBalance').textContent = '$' + data.total_balance.toLocaleString();
    }
    if (data.total_pnl) {
        const pnlElement = document.getElementById('totalPnL');
        pnlElement.textContent = (data.total_pnl >= 0 ? '+' : '') + '$' + Math.abs(data.total_pnl).toLocaleString();
        pnlElement.className = data.total_pnl >= 0 ? 'h4 mb-0 text-success' : 'h4 mb-0 text-danger';
    }
    if (data.active_positions) {
        document.getElementById('activePositions').textContent = data.active_positions;
    }
    if (data.open_orders) {
        document.getElementById('openOrders').textContent = data.open_orders;
    }
}

let portfolioChart = null;

function initializePortfolioChart() {
    const ctx = document.getElementById('portfolioChart');
    if (!ctx) return;
    
    // Create canvas element for Chart.js
    ctx.innerHTML = '<canvas id="portfolioChartCanvas" style="height: 300px;"></canvas>';
    const canvas = document.getElementById('portfolioChartCanvas');
    
    if (portfolioChart) {
        portfolioChart.destroy();
    }
    
    // Load portfolio data and create chart
    loadPortfolioData().then(data => {
        if (data && data.portfolio_history) {
            const chartData = {
                labels: data.portfolio_history.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
                }),
                datasets: [{
                    label: 'Стоимость портфолио',
                    data: data.portfolio_history.map(item => item.value),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            };
            
            portfolioChart = new Chart(canvas, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return 'Стоимость: $' + context.parsed.y.toLocaleString('ru-RU', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                callback: function(value) {
                                    return '$' + value.toLocaleString('ru-RU');
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
    }).catch(error => {
        console.error('Error loading portfolio chart:', error);
        ctx.innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                    <p>Ошибка загрузки графика портфолио</p>
                </div>
            </div>
        `;
    });
}

async function loadPortfolioData() {
    try {
        const response = await fetch('/trader/api/portfolio');
        if (!response.ok) {
            throw new Error('Failed to load portfolio data');
        }
        return await response.json();
    } catch (error) {
        console.error('Error loading portfolio data:', error);
        throw error;
    }
}

function loadWatchlist() {
    // Load user's watchlist from API
    fetch('/trader/api/watchlist')
        .then(response => response.json())
        .then(data => {
            updateWatchlistDisplay(data);
        })
        .catch(error => {
            console.log('Using default watchlist data');
            // Load demo data as fallback
            const demoData = {
                watchlist: [
                    { symbol: 'BTC/USDT', name: 'Bitcoin', price: 43250.00, change_percent_24h: 2.34 },
                    { symbol: 'ETH/USDT', name: 'Ethereum', price: 2650.00, change_percent_24h: -1.23 },
                    { symbol: 'BNB/USDT', name: 'Binance Coin', price: 310.50, change_percent_24h: 0.87 }
                ]
            };
            updateWatchlistDisplay(demoData);
        });
}

function updateWatchlist() {
    // Update watchlist prices
    const watchlistItems = document.querySelectorAll('#watchlist .list-group-item');
    // Implementation would fetch real-time prices and update display
}

function updateWatchlistDisplay(watchlistData) {
    const watchlistContainer = document.getElementById('watchlist');
    if (!watchlistContainer) return;
    
    if (watchlistData && watchlistData.watchlist && watchlistData.watchlist.length > 0) {
        let html = '';
        watchlistData.watchlist.forEach(crypto => {
            const changeClass = crypto.change_percent_24h >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = crypto.change_percent_24h >= 0 ? 'bi-arrow-up' : 'bi-arrow-down';
            
            html += `
                <div class="list-group-item list-group-item-action border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${crypto.symbol}</h6>
                            <small class="text-muted">${crypto.name}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">$${crypto.price.toLocaleString('ru-RU', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })}</div>
                            <small class="${changeClass}">
                                <i class="bi ${changeIcon}"></i>
                                ${Math.abs(crypto.change_percent_24h).toFixed(2)}%
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        watchlistContainer.innerHTML = html;
    }
}

function openQuickSell() {
    // Open quick sell modal or redirect to market page
    window.location.href = '{{ url_for("trader.market") }}';
}

function openAlertModal() {
    // Open price alert creation modal
    alert('Функция создания алертов будет добавлена в следующем обновлении');
}

function addToWatchlist() {
    // Open add to watchlist modal
    const symbol = prompt('Введите символ криптовалюты (например, BTC/USDT):');
    if (symbol) {
        // Add to watchlist via API
        alert('Добавлено в избранное: ' + symbol);
    }
}

// Portfolio card hover effects
document.addEventListener('DOMContentLoaded', function() {
    const portfolioCards = document.querySelectorAll('.portfolio-card');
    portfolioCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.transition = 'transform 0.2s ease';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});

// Blinking animation for live indicator
const style = document.createElement('style');
style.textContent = `
    .blink {
        animation: blink 2s infinite;
    }
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
